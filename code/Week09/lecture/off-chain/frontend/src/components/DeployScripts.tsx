import { PolicyId, Unit } from "lucid-cardano";
import React, { useContext, useState } from "react";
import {
    applyParamsToScript,
    Data,
    MintingPolicy,
    fromText,
} from "lucid-cardano";
import { AppStateContext } from "@/pages/_app";
import { signAndSubmitTx } from "@/utilities/utilities";

export default function DeployScripts() {
    const { appState, setAppState } = useContext(AppStateContext);
    const {
        lucid,
        wAddr,
        oracleScript,
        collateralScript,
        txScriptsDeployment,
        txCollScriptDeployment,
        txMintingPolScriptDeployment,
    } = appState;
    const [mPerc, setMPerc] = useState(150n);

    const parseMinPerc = (r: string) => {
        const mPerc = BigInt(Number(r));
        if (Number.isNaN(mPerc)) return;
        setMPerc(mPerc);
    };

    const getFinalMintingPolicy = async () => {
        if (!lucid || !wAddr || !oracleScript || !mPerc) return;
        const tn = fromText("USDP");
        const oracleValidatorHash = await lucid.utils.validatorToScriptHash(
            oracleScript
        );
        const collateralValidatorHash = await lucid.utils.validatorToScriptHash(
            collateralScript
        );

        console.log("Applying minting script to these parameters: ", {
            OracleValHash: oracleValidatorHash,
            CollateralValHash: collateralValidatorHash,
            minPercent: mPerc,
        });

        const Params = Data.Tuple([Data.Bytes(), Data.Bytes(), Data.Integer()]);
        type Params = Data.Static<typeof Params>;
        const scPolicy: MintingPolicy = {
            type: "PlutusV2",
            script: applyParamsToScript<Params>(
                "590fae590fab0100003232323322323233223232323233223232323232323232323232323232323232323232323232323232323232322222322323253353232323232323232323232325333500915335533550041034133573892113696e76616c6964206275726e20616d6f756e74000331533553355006213301750083500122220031033103413357389201196f776e65722773207369676e6174757265206d697373696e6700033103315335533550041034133573892113696e76616c6964206275726e20616d6f756e740003315335333573466e214004cdc0812280281a019881a099ab9c4901216c69717569646174696f6e207468726573686f6c64206e6f742072656163686564000331033153355335333573466e1cc8cccd54c06048004c8cd407088ccd407400c004008d4068004cd406c888c00cc008004800488cdc0000a400400290002801240040680662068266ae712401146f7261636c6520696e707574206d697373696e6700033153355335333573466e2540152000033034103413357389211e6d696e74656420616d6f756e74206d75737420626520706f736974697665000331533553353232333573466e200080040d40d94019400440d04cd5ce2481196d696e74656420616d6f756e742065786365656473206d61780003315335533553335355003220021503d2130200012153353301e00150082130210011503e215335333573466e3cd40048888010c0740240d40d054cd4ccd5cd19b87350012222002500603503415335533535001222200110351034133017500835001222200310341034103410331034133573892122696e76616c696420646174756d20617420636f6c6c61746572616c206f75747075740003310331033103313370666e08cdc199980a1aa8011100080e80e9a805911000a99a9aa99aa8008981b24c442a66a002200444260749311112999a8010a82010981200090a99a99810800a8059098128008a8209080089931901c19ab9c491184f7261636c65277320646174756d206e6f7420666f756e640003f4820225e84c020d5401488888888888802c54cd4c8c8d4004888888888888ccd54c0984800488d40088888d401088cd4008802094cd4ccd5cd19b8f001017048047133504d335504f0050060081008504500a50053500922200213033498884d4008894cd400c4cd540f0008004884c0e52615335500221333573466e1ccdc08109a80091110012801018818081789998081aa801111111111111004180b8019b98490104555344500015335300535500122222222222200c1503722153350011533353500222220021503921301c0012153353301a001500421301d0011503a221503b135001220023333573466e1cd55cea80324000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd40b00b4d5d0a80619a8160169aba1500b33502c02e35742a014666aa060eb940bcd5d0a804999aa8183ae502f35742a01066a05806a6ae85401cccd540c00d9d69aba150063232323333573466e1cd55cea801240004664424660020060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008cd4101d69aba150023041357426ae8940088c98c8120cd5ce02202782309aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a8203ad35742a00460826ae84d5d1280111931902419ab9c04404f046135573ca00226ea8004d5d09aba2500223263204433573808009608426aae7940044dd50009aba1500533502c75c6ae854010ccd540c00c88004d5d0a801999aa8183ae200135742a00460686ae84d5d1280111931902019ab9c03c04703e135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a00c60486ae84d5d1280311931901919ab9c02e0390303333573466e1d401d20042122200223333573466e1d402120022122200323333573466e1d402520002122200123263203333573805e07406206005e640026aa06e44a66a0022a06446442a66a6603a6aa00444440086606e60746a00e444006a070266a068a004600a0022600a00226a00244002640026aa06c44a66a0022a06246442a66a660386aa00444440086606c60726a00c444004a06e266a066a004600a0022600a00226a00244002666444246660020080060046eb8020dd70039bad006103413263202d33573892010350543500034135573ca00226ea80044d55ce9baa0012223232300100532001355030223350014800088d4008894cd4ccd5cd19b8f00200902902813007001130060033200135502f223350014800088d4008894cd4ccd5cd19b8f0020070280271001130060032235002222222222222533533355300f12001335012225335002210031001503525335333573466e3c0380040b40b04d40dc004540d8010840b440acc8004d540a888448894cd40044d401800c884ccd4024014c010008ccd54c01c4800401401000448d40048800448d40048800848848cc00400c008c8004d5409888448894cd40044008884cc014008ccd54c01c480040140100048d400488cccd40048c98c8084cd5ce249024c680002820012326320213357389201024c68000282326320213357389201024c6800028232235001222222222222300e002320013550252253350011502322135002225335333573466e3c00801c0780744d40a00044c01800d22100232323232323333333574800c46666ae68cdc39aab9d5006480008cccd55cfa8031281391999aab9f500625028233335573ea00c4a05246666aae7d4018940a88cccd55cf9aba2500725335300f35742a01642a66a60206ae85402c854cd4c040d5d0a80590a99a991919191999999aba400423333573466e1d40092002233335573ea00846a06c2440044a06a06e46666ae68cdc3a801a400046666aae7d40148d40dc488004940d80e0940d40bc0b8940cc940cc940cc940cc0d44d55cea80109aab9e5001137540026ae85402c84d40c048cccc00401401000c008540b8540b4540b0540ac940ac0b40b00ac0a80a4940980809409494094940949409409c4d5d1280089aba25001135744a00226aae7940044dd500091999999aba40012501f2501f2501f235020375a0044a03e04246666666ae90004940789407894078940788d407cdd7001010111a801111a801911919a802919a8021299a999ab9a3371e0040020360342a00620344034466a00840344a66a666ae68cdc780100080d80d0a801880d0a99a80190a99a8011099a801119a801119a801119a801119806801000900e919a801100e91980680100091100e91119a802100e911299a999ab9a3370e00c00604003e2a66a666ae68cdc380280101000f8999ab9a3370e00800204003e203e203e20302a66a00242030203044666ae68cdc7801000809809240002464460046eb0004c8004d5407488cccd55cf8009280c919a80c18021aba100230033574400403c464646666ae68cdc39aab9d5002480008cc8848cc00400c008c028d5d0a80118029aba135744a004464c6402e66ae7004c0780544d55cf280089baa0012323232323333573466e1cd55cea8022400046666444424666600200a0080060046464646666ae68cdc39aab9d5002480008cc07cc04cd5d0a80119a8068091aba135744a004464c6403866ae7006008c0684d55cf280089baa00135742a008666aa010eb9401cd5d0a8019919191999ab9a3370ea0029002119091118010021aba135573ca00646666ae68cdc3a80124004464244460020086eb8d5d09aab9e500423333573466e1d400d20002122200323263201e33573803404a03803603426aae7540044dd50009aba1500233500975c6ae84d5d1280111931900c19ab9c01401f016135744a00226ae8940044d55cf280089baa0011335500175ceb44488c88c008dd5800990009aa80d11191999aab9f0022501723350163355018300635573aa004600a6aae794008c010d5d100180e09aba100112232323333573466e1d400520002350193005357426aae79400c8cccd5cd19b87500248008940648c98c8054cd5ce00880e00980909aab9d500113754002464646666ae68cdc3a800a400c46424444600800a600e6ae84d55cf280191999ab9a3370ea004900211909111180100298049aba135573ca00846666ae68cdc3a801a400446424444600200a600e6ae84d55cf280291999ab9a3370ea00890001190911118018029bae357426aae7940188c98c8054cd5ce00880e00980900880809aab9d500113754002464646666ae68cdc39aab9d5002480008cc8848cc00400c008c014d5d0a8011bad357426ae8940088c98c8044cd5ce00680c00789aab9e5001137540024646666ae68cdc39aab9d5001480008dd71aba135573ca004464c6401e66ae7002c0580344dd5000919191919191999ab9a3370ea002900610911111100191999ab9a3370ea004900510911111100211999ab9a3370ea00690041199109111111198008048041bae35742a00a6eb4d5d09aba2500523333573466e1d40112006233221222222233002009008375c6ae85401cdd71aba135744a00e46666ae68cdc3a802a400846644244444446600c01201060186ae854024dd71aba135744a01246666ae68cdc3a8032400446424444444600e010601a6ae84d55cf280591999ab9a3370ea00e900011909111111180280418071aba135573ca018464c6403066ae7005007c05805405004c0480440404d55cea80209aab9e5003135573ca00426aae7940044dd50009191919191999ab9a3370ea002900111999110911998008028020019bad35742a0086eb4d5d0a8019bad357426ae89400c8cccd5cd19b875002480008c8488c00800cc020d5d09aab9e500623263201133573801a03001e01c26aae75400c4d5d1280089aab9e500113754002464646666ae68cdc3a800a4004460266eb8d5d09aab9e500323333573466e1d400920002321223002003375c6ae84d55cf280211931900719ab9c00a01500c00b135573aa00226ea8004488c8c8cccd5cd19b87500148010848880048cccd5cd19b875002480088c84888c00c010c018d5d09aab9e500423333573466e1d400d20002122200223263200f33573801602c01a01801626aae7540044dd50009191999ab9a3370ea0029001100291999ab9a3370ea0049000100291931900599ab9c007012009008135573a6ea800448800848800524103505431002326320043357389212665787065637465642065786163746c79206f6e6520636f6c6c61746572616c206f75747075740000b23263200333573892012165787065637465642065786163746c79206f6e65206f7261636c6520696e7075740000a4984488008488488cc00401000c448848cc00400c0088848cc00400c00848488c00800c44880048488c00400c48004448c8c00400488cc00cc008008005",
                [oracleValidatorHash, collateralValidatorHash, mPerc],
                Params
            ),
        };
        const scPolicyId: PolicyId = lucid!.utils.mintingPolicyToId(scPolicy);

        const unit: Unit = scPolicyId + tn;
        setAppState({
            ...appState,
            scPolicyIdHex: scPolicyId,
            scTokenNameHex: tn,
            scAssetClassHex: unit,
            scPolicy: scPolicy,
            minPercent: Number(mPerc),
            oracleScriptHash: oracleValidatorHash,
            collateralScriptHash: collateralValidatorHash,
        });

        return scPolicy;
    };

    const deployBothScriptsInOneTx = async () => {
        if (!lucid || !wAddr || txScriptsDeployment) return;
        console.log("deployBothScriptsInOneTx -> appState: ", appState);
        const scPolicy = await getFinalMintingPolicy();
        if (!scPolicy) return;
        const tx = await lucid
            .newTx()
            .payToAddressWithData(
                wAddr,
                { inline: Data.void(), scriptRef: collateralScript },
                {}
            )
            .payToAddressWithData(
                wAddr,
                { inline: Data.void(), scriptRef: scPolicy },
                {}
            )
            .complete();

        const pid = await signAndSubmitTx(tx);
        console.log("Deployed both scripts: ", pid);
        setAppState({ ...appState, txScriptsDeployment: pid });
    };

    return (
        <div>
            <div className="flex flex-row">
                <p>Minimum Percentage of Collateral:</p>
                <input
                    type="number"
                    value={Number(mPerc)}
                    onChange={(e) => parseMinPerc(e.target.value)}
                />
            </div>
            <button
                onClick={deployBothScriptsInOneTx}
                disabled={
                    !wAddr ||
                    !oracleScript ||
                    !mPerc ||
                    !!txCollScriptDeployment ||
                    !!txMintingPolScriptDeployment
                }
                className="bg-blue-500 disabled:bg-slate-300 hover:bg-orange-700 text-white font-bold p-2 m-4 rounded"
            >
                {" "}
                Deploy Scripts
            </button>
        </div>
    );
}
